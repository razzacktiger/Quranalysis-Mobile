{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "command:end-session",
  "title": "end-session",
  "description": "Archive current session and aggregate metrics",
  "type": "object",
  "properties": {
    "duration_minutes": {
      "type": "number",
      "description": "Duration of the session in minutes"
    }
  },
  "x-workflow": {
    "aliases": ["/end-session"],
    "requires": {
      "params": [],
      "optional_params": ["duration_minutes"],
      "state": ["session.started"]
    },
    "state_reads": [
      "state/session.json",
      "state/metrics.json"
    ],
    "state_writes": [
      {
        "file": "state/session.json",
        "action": "reset",
        "fields": ["all"]
      },
      {
        "file": "state/metrics.json",
        "action": "append",
        "fields": ["sessions.recent"]
      },
      {
        "file": "state/metrics.json",
        "action": "update",
        "fields": ["sessions.averages", "by_task_type", "by_task_size"]
      }
    ],
    "archive_to": "state/archive/session-{date}-{n}.json",
    "checklist": [
      "Ask user for session duration",
      "Archive current session",
      "Update metrics aggregates",
      "Check for signals (green/yellow/red)",
      "Reset session state"
    ],
    "instructions": "../instructions/workflows/end-session.md"
  }
}
